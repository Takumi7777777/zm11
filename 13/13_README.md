# Week 13

```
uv add statsmodels
```


1. statsmodels の紹介（回帰分析）
2. CLIプログラムの企画


## 1. statsmodels 

Python で統計分析をするときによく使われるライブラリ。今後、次の3つのライブラリが登場するので頭の片隅にいれておこう。

- 古典的な統計モデルは statsmodels <https://www.statsmodels.org/stable/>
- 機械学習モデルは scikitlearn <https://scikit-learn.org/stable/>
- パネルデータ分析は linearmodels <https://bashtage.github.io/linearmodels/>

Pandas のデータフレームとうまく連携できる。

### 線形回帰モデルとは？

```
Y = a + b X1 + c X2 + u
```

各観測について、3つの値が測定されているとする。例えば、

- 各都道府県に対して (地域GDP、大学数、昼夜人口比率)
- 各企業に対して（従業員数、産業分類、売上）

などなど。回帰分析というのは、データの背後にある従属関係を見つけ出す手法のこと。各変数の間には明らかな従属関係（因果関係）がありそうなものもあれば、明らかでないものもある。

具体的にどういうふうに使うかというと、例えば、

- 昼夜人口比率の決定要因は地域GDPである

のような仮説を立てたとしよう。企業活動が活発な地域は域外からの通勤が多いという推論である。
これをデータで示したい、というようなときに回帰分析が使える。このとき、 (地域GDP、昼夜人口比率) というデータを集めてきて、

```
昼夜人口比率 = a + b * 地域GDP + (誤差)
```

という1次式でデータを近似するのが線形回帰分析である。a, b の計算の仕方はいろいろな手法があるけれども一番よく使われるのは最小二乗法という手法である（簡単に計算できるし、よい統計的な性質をもっているのでよく使われる）。誤差のところは計算すると出てくる。右辺に変数が1つだけなので単回帰分析という。
なんとなくうまく行きそうである。

さらにじっくり考えていると、ふと次のようなことを思いついた：大学生がその地域に通学する場合もあるなぁ。その影響を取り除くためには単に、上の式に大学関係の変数を入れればよい。

```
昼夜人口比率 = a + b * 地域GDP + c * 大学数 + (誤差)
```

右辺の変数が2つになったので、これは重回帰分析とよばれる。左辺変数は被説明変数、右辺変数は説明変数とよばれる。
a, b, c は回帰係数と呼ばれる。計算すると出てくる数値である。統計的な話はおいおい理解を深めていくとして、今回は a, b, c, d, ... (右辺変数の数 + 1 だけ係数がでてくる）をPython で出力する方法を見ておきたい。

モデル式の簡便記法として以下のような記法を採用する：

```
昼夜人口比率 ~ 地域GDP + 大学数
```

チルダ ~ の左が被説明変数、右辺が説明変数（足し算記号で繋ぐ）。このように書いたモデルはフォーミュラとよぶ。
欠落変数が、求めたい結果に正の影響を与えるのか負の影響を与えるのかも考えるとよい

### statsmodels 

あとは簡単である。`13a.py` をみてほしい。Penguins データセットを使って回帰分析を実行している。

モデル式の指定は次の部分である。 `smf.ols` の1つ目の変数に上の簡便記法（フォーミュラ）で指定する。`data`変数で与えたデータフレームの列名が使われていることを確認しよう。

```
model = smf.ols("body_mass_g ~ bill_length_mm + species", data=penguins)
```

回帰分析のプログラムは3段階のプロセスである。

- モデルの定義 (ここでは `smf.ols`)
- データの当てはめ（`fit()`）
- 結果の出力 (`summary()`)

よくやる切り分けになので使っているうちに覚えると思う。

結果を見ると次のように書いている。

```
Intercept               153.739688
species[T.Chinstrap]   -885.812080
species[T.Gentoo]       578.629163
bill_length_mm           91.435819
```

Intercept (定数項) を含めて 4つの変数があり、その係数を示している。式で書くと次のような意味だ。

```
body_mass_g = 153.74 + (-885.81) * species[T.Chinstrap] 
               + 578.63 * species[T.Gentoo] + 91.44 * bill_length_mm
```

変数は3つしか与えていないのに、と思った人もいるかもしれない。`species` は文字列変数なので `species[T.Chinstrap]`, `species[T.Gentoo]` のようなダミー変数が自動的に作られている。この場合 Adelie種を基準にして、対象の種が Chinstrap である場合には 885.81g 小さく、Gentoo の場合は 578.63g 大きいと予測されているということ。


### 課題

- 変数を入れ替えて分析する。
- 結果の表を数式にしてみる。


## 2. CLIプログラムの企画

以前作った zmXX プログラムを拡張していこう。Python の基本文法と、簡単なデータ分析のテクニックを学んだので、日頃から使える自作ツールを作り始めるのにちょうどいい頃合いだろう。もちろん、まだ自分自身では解決できないテクニックを駆使しないといけないかもしれないけれど、ChatGPTや Claude の力を借りればよい。もちろん全部を受け入れてはいけないし、コピペだけで完成させようなどとは思わないでほしい。生成AIの出力をよく読んで理解して自分の血肉にしてほしい。生成AIを学習ツールとして使い尽くそう。

### 何を作ろう？

よくやる作業なのにいちいちブラウザを立ち上げないといけないのはめんどうだなぁと思うことがあれば、それをコマンドにするとよい。例えば、次のようなものはどうだろう。

#### 時事

- ウォッチしている株や為替の最新情報を取得, 作図
- ニュースサイトのヘッドラインを表示する

#### 研究補助

- 政府統計の新しいデータをダウンロードして表示する
- Excel を開かずに CSV ファイルをちょっと覗き見するコマンド（行数、最初のN行を見るとか）
- 最近1週間、特定のキーワードを含む X の投稿をファイルに保存する（要API）

#### その他


### 事例

佐藤が作ったものを共有する。

```
uv tool install git+https://github.com/kenjisato/zm00 --reinstall
```

**カレンダー表示**

```
zm00 c
zm00 c 2025 11
```

**e-stat の公表スケジュール**

```
zm00 r
```

私は

- 来週木曜日は何日だっけ？のようなことが多いので、`zm00 c` でカレンダーが出ればいいなぁと考えた。指定した月のカレンダーを表示するのは `zm00 c 2025 11` のようにしよう、とか。
- 政府統計の公表スケジュールをフォローしておくと仕事が捗りそうだなぁ。 `zm00 r` で最新情報が出るようにしよう。デフォルトは今日から1週間だけど、数日前の情報も見たいかもしれないので `zm00 r --days-before 7` のようにすると7日前の予定も取得しよう
  

のように考えました。

### 課題

みなさんも、

```
zmXX subcommand1 パラメータ
```

で何か便利かつ動くのを作ってみましょう。

今日は残り時間でアイデア出しをしてみてください。


#　randam_finance_term.pyの使い方

1. helloと入力する
2. ランダムに金融用語が出てくる
3.自分の知識で説明する
4. さらに、ヤフーニュースからとってきた関連ニュースのリンクがでてくるので、理解を深める
5. 1~4を繰り返す
